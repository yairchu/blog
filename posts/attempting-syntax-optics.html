<!DOCTYPE html>
<html lang="en" dir="ltr">
<head profile="http://www.w3.org/2005/10/profile">
  <meta name="description" content="Yair&#39;s website">
  <meta name="author" content="Yair Chuchem">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@yairchu">
<meta name="twitter:creator" content="@yairchu">
<meta name="twitter:title" content="Trying to create Syntax Optics">
  <meta name="twitter:description" content="Declarative parsing and pretty printing with error reporting">
  <meta name="twitter:image" content="https://yairchu.github.io//images/camera-parts.png">
  <title>Trying to create Syntax Optics</title>
  <link rel="stylesheet" href="/css/syntax.css">
  <meta property="og:title" content="Trying to create Syntax Optics" />
  <meta property="og:image" content="https://yairchu.github.io/images/camera-parts.png" />
  <meta charset="UTF-8">
  <meta name=viewport content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/style.css">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3ZVL4J64MW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3ZVL4J64MW');
  </script>
</head>
<body>
  <header dir="ltr">
      <nav>
          <a href="/"> HOME </a>
          <a href="/projects/recommendations"> FAVS </a>
      </nav>
  
      <div class="right-sidebar">
          <a class="ext-link" href="https://github.com/yairchu">
            <img src="/images/github-logo.png" alt="Github Profile"/>
        </a>

          <a class="ext-link" href="https://twitter.com/yairchu">
            <img src="/images/twitter-logo.png" alt="Twitter Profile"/>
        </a>
    <div id="theme-button">DAY</div>
      </div>
  </header>

<div id="page">
  <div class="wrapper">
    <div class="masthead">
      <span class="title">
        Trying to create Syntax Optics
      </span>

      <img class="post-image" src="/images/camera-parts.png">
      <span class="byline">by Yair Chuchem</span>
      <span class="date">2020.11.19</span>
      <div class="metadata">
      </div>
      <div class="tags">
        <a href="/tag/code" class="tag">code</a>
        <a href="/tag/declarative" class="tag">declarative</a>
        <a href="/tag/haskell" class="tag">haskell</a>
        <a href="/tag/optics" class="tag">optics</a>
        <a href="/tag/parsing" class="tag">parsing</a>
      </div>
    </div>
  </div>
  <article class="post">

    <p>The journey to create combinators for parsing and pretty-pretting
continues!</p>
<p>This post (along with the new <a
href="https://github.com/yairchu/syntax-optics/"><code>syntax-optics</code>
repo</a>) combines two previous efforts:</p>
<ul>
<li><a href="/posts/codecs-as-prisms-asts">"Elegant AST Parsing and
Building with Prisms"</a> declared <code>Prism</code>s to parse and
print ASTs, but lacking descriptive errors when the parsing fails</li>
<li><a href="/posts/optics-with-error-reporting">"Basic error reporting
for optics"</a> declared new <code>lens</code>-compatible optics that
add error reporting to parse errors</li>
</ul>
<p>The resulting combinators let us nicely declare syntax:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Expr</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=</span> <span class="dt">Lit</span> <span class="dt">Int</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">Add</span> <span class="dt">Expr</span> <span class="dt">Expr</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">Mul</span> <span class="dt">Expr</span> <span class="dt">Expr</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>makePrisms &#39;<span class="dt">&#39;Expr</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="ot">expr ::</span> <span class="dt">VerbosePrism&#39;</span> <span class="dt">String</span> <span class="dt">String</span> <span class="dt">Expr</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>expr <span class="ot">=</span> tokens <span class="op">.</span> takeExpr <span class="op">.</span> endOfTokens</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="ot">takeExpr ::</span> <span class="dt">VerbosePrism&#39;</span> <span class="dt">String</span> [<span class="dt">String</span>] (<span class="dt">Expr</span>, [<span class="dt">String</span>])</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>takeExpr <span class="ot">=</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    infixOpLeftRecursion p <span class="st">&quot;+&quot;</span> _Add <span class="op">$</span>           <span class="co">-- Additions of</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    infixOpLeftRecursion p <span class="st">&quot;*&quot;</span> _Mul <span class="op">$</span>           <span class="co">-- multiplications of</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    tryMatchAtom p (prismFallback _Lit) _Show <span class="op">$</span> <span class="co">-- literals or</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    parens takeExpr                             <span class="co">-- expressions in parens</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        p <span class="ot">=</span> <span class="dt">Proxy</span> <span class="op">@</span><span class="dt">String</span></span></code></pre></div>
<p><code>expr</code> can be used to both pretty-print and to parse:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> expr <span class="op">#</span> (<span class="dt">Lit</span> <span class="dv">1</span> <span class="ot">`Mul`</span> (<span class="dt">Lit</span> <span class="dv">2</span> <span class="ot">`Add`</span> <span class="dt">Lit</span> <span class="dv">3</span>)) <span class="ot">`Add`</span> <span class="dt">Lit</span> <span class="dv">4</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;1 * (2 + 3) + 4&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="st">&quot;1 * (2 + 3) + 4&quot;</span> <span class="op">^?</span> expr</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> (<span class="dt">Add</span> (<span class="dt">Mul</span> (<span class="dt">Lit</span> <span class="dv">1</span>) (<span class="dt">Add</span> (<span class="dt">Lit</span> <span class="dv">2</span>) (<span class="dt">Lit</span> <span class="dv">3</span>))) (<span class="dt">Lit</span> <span class="dv">4</span>))</span></code></pre></div>
<p>Now, to also get the syntax errors when parsing, we can use the new
<code>^??</code> operator rather than <code>lens</code>'s
<code>^?</code>:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="st">&quot;2 + 3 * * 5&quot;</span> <span class="op">^??</span> expr</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Left</span> <span class="st">&quot;Unexpected \&quot;*\&quot;&quot;</span></span></code></pre></div>
<h2 id="still-lacking-in-the-library">Still lacking in the library</h2>
<ul>
<li>The errors from <code>syntax-optics</code> do not currently report
source-code locations of syntax errors.</li>
<li>An <code>AVerbosePrism</code> type synonym, similar in spirit to
<code>ALens</code> and <code>APrism</code>, is currently missing. With
it the library would not need <code>RankNTypes</code> nor
<code>Proxy</code> parameters which it currently requires
(<code>p</code> in the example in this post).</li>
</ul>
<p>I've tried to define <code>AVerbosePrism</code> but haven't succeeded
so far. Help and advice from <code>lens</code> wizards would be very
appreciated!</p>
<h2 id="notes">Notes</h2>
<ul>
<li>Title image by <a
href="https://commons.wikimedia.org/wiki/File:Reflex_camera_simple_labels.svg">Jean
Fran√ßois WITZ</a>.</li>
</ul>

    <!--Comments-->
    <script src="https://giscus.app/client.js"
      data-repo="yairchu/yairchu.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnkyMTI0MDQ3MDk="
      data-category="Announcements"
      data-category-id="DIC_kwDODKkJ5c4Ckke9"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="light"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
  </article>

</div>

<footer>
    Web site built with Haskell using <a href="https://github.com/ChrisPenner/slick">slick</a> ‚ù§Ô∏è
</footer>

<link href='https://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
<script src="/js/main.js"></script>
</body>
</html>
