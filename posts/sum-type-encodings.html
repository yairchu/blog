<!DOCTYPE html>
<html lang="en"> 
<head profile="http://www.w3.org/2005/10/profile">
    <meta charset="UTF-8">
    <meta name="description" content="Yair&#39;s website">
    <meta name="author" content="Yair Chuchem">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@yairchu">
<meta name="twitter:creator" content="@yairchu">
<meta name="twitter:title" content="The four simple ways to encode sum-types">
    <meta name="twitter:description" content="How and why to encode sum types?">
    <meta name="twitter:image" content="https://yairchu.github.io/blog/images/Loc_Bloc_example_1_of_Disney.jpg">
    <title>The four simple ways to encode sum-types</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">
</head>
<body>
    <header>
        <nav>
            <a id="beacon" href="/">
                <div id="home-text"> HOME </div>
            </a>
        </nav>
    
        <div class="right-sidebar">
            <a class="ext-link" href="https://github.com/yairchu">
            <img src="/images/github-logo.png" alt="Github Profile"/>
        </a>

            <a class="ext-link" href="https://twitter.com/yairchu">
            <img src="/images/twitter-logo.png" alt="Twitter Profile"/>
        </a>
    <div id="theme-button">DAY</div>
        </div>
    </header>

<div id="page">
    <div class="wrapper">
        <div class="masthead">
            <span class="title">
                The four simple ways to encode sum-types
            </span>
            <br>

            <img class="post-image" src="/images/Loc_Bloc_example_1_of_Disney.jpg">
            <br>
            <span class="byline">by Yair Chuchem</span>
            <br>
            <span class="date">2019.11.06</span>
            <br>
            <div class="metadata">
            </div>
        </div>
    </div>
    <article class="post">
        <p>There are four simple ways to encode sum types:</p>
<ul>
<li>Directly, if your programming language supports them</li>
<li>"Church encoding"</li>
<li>"Final style"</li>
<li>The OO pattern</li>
</ul>
<p>We'll introduce them and discuss their pros and cons, focusing on open (extensible) sum-types.</p>
<h2 id="direct">Direct</h2>
<p>All the up and coming programming languages support sum types, by feature if not by name:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Language</th>
<th style="text-align: left;">Feature</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">F#</td>
<td style="text-align: left;"><a href="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/discriminated-unions">Discriminated Unions</a></td>
</tr>
<tr class="even">
<td style="text-align: right;">Elm</td>
<td style="text-align: left;"><a href="https://guide.elm-lang.org/types/custom_types.html">Variants</a></td>
</tr>
<tr class="odd">
<td style="text-align: right;">Rust</td>
<td style="text-align: left;"><a href="https://doc.rust-lang.org/book/ch06-00-enums.html">Enumerations</a></td>
</tr>
<tr class="even">
<td style="text-align: right;">Swift</td>
<td style="text-align: left;"><a href="https://docs.swift.org/swift-book/LanguageGuide/Enumerations.html">Enumerations</a></td>
</tr>
<tr class="odd">
<td style="text-align: right;">Kotlin</td>
<td style="text-align: left;"><a href="https://kotlinlang.org/docs/reference/sealed-classes.html">Sealed Classes</a></td>
</tr>
<tr class="even">
<td style="text-align: right;">Haskell</td>
<td style="text-align: left;"><a href="https://wiki.haskell.org/Algebraic_data_type">Algebraic Data Types</a></td>
</tr>
</tbody>
</table>
<p>We'll use Haskell to demonstrate them:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">data</span> <span class="dt">Shape</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>    <span class="ot">=</span> <span class="dt">Rect</span> {<span class="ot"> width ::</span> <span class="dt">Float</span>,<span class="ot"> height ::</span> <span class="dt">Float</span> }</span>
<span id="cb1-3"><a href="#cb1-3"></a>    <span class="op">|</span> <span class="dt">Circle</span> {<span class="ot"> radius ::</span> <span class="dt">Float</span> }</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="ot">area ::</span> <span class="dt">Shape</span> <span class="ot">-&gt;</span> <span class="dt">Float</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>area (<span class="dt">Rect</span> w h) <span class="ot">=</span> w <span class="op">*</span> h</span>
<span id="cb1-7"><a href="#cb1-7"></a>area (<span class="dt">Circle</span> r) <span class="ot">=</span> <span class="fu">pi</span> <span class="op">*</span> r <span class="op">*</span> r</span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="op">&gt;</span> area (<span class="dt">Rect</span> <span class="dv">3</span> <span class="dv">5</span>)</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="dv">15</span></span></code></pre></div>
<h2 id="church-encoding">Church encoding</h2>
<p>How would we encode our type in legacy languages which don't support sum types?</p>
<p>Famous minimalist <a href="https://en.wikipedia.org/wiki/Alonzo_Church">Alonzo Church</a> has devised a method:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="ot">{-# LANGUAGE RankNTypes #-}</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">data</span> <span class="dt">ShapeHandlers</span> r <span class="ot">=</span> <span class="dt">ShapeHandlers</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    {<span class="ot"> handleRect ::</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> r</span>
<span id="cb2-5"><a href="#cb2-5"></a>    ,<span class="ot"> handleCircle ::</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> r</span>
<span id="cb2-6"><a href="#cb2-6"></a>    }</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="kw">type</span> <span class="dt">Shape</span> <span class="ot">=</span> (<span class="kw">forall</span> a<span class="op">.</span> <span class="dt">ShapeHandlers</span> a <span class="ot">-&gt;</span> a)</span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="ot">rect ::</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Shape</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>rect w h handlers <span class="ot">=</span> handleRect handlers w h</span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="ot">circle ::</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Shape</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>circle r handlers <span class="ot">=</span> handleCircle handlers r</span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="ot">area ::</span> <span class="dt">Shape</span> <span class="ot">-&gt;</span> <span class="dt">Float</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>area shape <span class="ot">=</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>    shape</span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="dt">ShapeHandlers</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>    { handleRect <span class="ot">=</span> \w h <span class="ot">-&gt;</span> w <span class="op">*</span> h</span>
<span id="cb2-21"><a href="#cb2-21"></a>    , handleCircle <span class="ot">=</span> \r <span class="ot">-&gt;</span> <span class="fu">pi</span> <span class="op">*</span> r <span class="op">*</span> r</span>
<span id="cb2-22"><a href="#cb2-22"></a>    }</span>
<span id="cb2-23"><a href="#cb2-23"></a></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="op">&gt;</span> area (rect <span class="dv">3</span> <span class="dv">5</span>)</span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="dv">15</span></span></code></pre></div>
<p>While originally intended for use in his minimal programming language "Lambda Calculus", this encoding is suitable for most popular languages. Java/C# supports it via abstract generic methods. In C++ or Go we'll have to resort to casts or side-effects to encode this (the <a href="https://en.wikipedia.org/wiki/Visitor_pattern">Visitor pattern</a>).</p>
<h2 id="final-style-extending-church-encodings-using-type-classes">Final style: Extending church-encodings using type classes</h2>
<p>We can encode the record from the church encoding using a type-class:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="ot">{-# LANGUAGE RankNTypes #-}</span></span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="kw">class</span> <span class="dt">ShapeHandlers</span> r <span class="kw">where</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="ot">    rect ::</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> r</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="ot">    circle ::</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> r</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="kw">type</span> <span class="dt">Shape</span> <span class="ot">=</span> (<span class="kw">forall</span> a<span class="op">.</span> <span class="dt">ShapeHandlers</span> a <span class="ot">=&gt;</span> a)</span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="kw">newtype</span> <span class="dt">Area</span> <span class="ot">=</span> <span class="dt">Area</span> {<span class="ot"> area ::</span> <span class="dt">Float</span> }</span>
<span id="cb3-10"><a href="#cb3-10"></a></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="kw">instance</span> <span class="dt">ShapeHandlers</span> <span class="dt">Area</span> <span class="kw">where</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>    rect w h <span class="ot">=</span> <span class="dt">Area</span> (w <span class="op">*</span> h)</span>
<span id="cb3-13"><a href="#cb3-13"></a>    circle r <span class="ot">=</span> <span class="dt">Area</span> (<span class="fu">pi</span> <span class="op">*</span> r <span class="op">*</span> r)</span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="op">&gt;</span> area (rect <span class="dv">3</span> <span class="dv">5</span>)</span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="dv">15</span></span></code></pre></div>
<p>The main benefit of using this encoding is that type class constraints are trivially composable, which translates to encoding extensible sum-types! For example: <code>(forall a. (ShapeHandlers a, MoreHandlers a) =&gt; a)</code></p>
<p>With a small modification (avoiding universal quantification) this becomes Carette et al's <a href="http://okmij.org/ftp/tagless-final/index.html">"Final Style"</a>, which is also commonly known as "<code>mtl</code> style".</p>
<p>A similar encoding in OO languages, using interfaces instead of type classes is Oliviera et al's <a href="https://www.cs.utexas.edu/~wcook/Drafts/2012/ecoop2012.pdf">"Object Algebras"</a>.</p>
<h2 id="the-oo-pattern">The OO pattern</h2>
<p>This is a common way to represent sum types in object oriented languages:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">data</span> <span class="dt">Rect</span> <span class="ot">=</span> <span class="dt">Rect</span> {<span class="ot"> width ::</span> <span class="dt">Float</span>,<span class="ot"> height ::</span> <span class="dt">Float</span> }</span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw">data</span> <span class="dt">Circle</span> <span class="ot">=</span> <span class="dt">Circle</span> {<span class="ot"> radius ::</span> <span class="dt">Float</span> }</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="kw">class</span> <span class="dt">Area</span> a <span class="kw">where</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="ot">    area ::</span> a <span class="ot">-&gt;</span> <span class="dt">Float</span></span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="kw">instance</span> <span class="dt">Area</span> <span class="dt">Rect</span> <span class="kw">where</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>    area (<span class="dt">Rect</span> w h) <span class="ot">=</span> w <span class="op">*</span> h</span>
<span id="cb4-10"><a href="#cb4-10"></a></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="kw">instance</span> <span class="dt">Area</span> <span class="dt">Circle</span> <span class="kw">where</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>    area (<span class="dt">Circle</span> r) <span class="ot">=</span> <span class="fu">pi</span> <span class="op">*</span> r <span class="op">*</span> r</span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="op">&gt;</span> area (<span class="dt">Rect</span> <span class="dv">3</span> <span class="dv">5</span>)</span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="dv">15</span></span></code></pre></div>
<p>This encoding is naturally open! We can add shapes as we please, and in posh languages which support type-classes or traits we can also add more operations on them without modifying existing code.</p>
<h2 id="putting-these-approaches-to-the-test">Putting these approaches to the test</h2>
<p>Let's explore how these approaches fare against some simple challenges.</p>
<h3 id="supporting-new-shapes">Supporting new shapes</h3>
<p>Suppose we wanted to write code that can support more types of shapes, without modifying our shape data definition (aka the <a href="https://en.wikipedia.org/wiki/Expression_problem">Expression problem</a>).</p>
<p>The direct sum-type can't be extended, nor can its church encoding. But the final and OO styles can.</p>
<p>Final style:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">class</span> <span class="dt">CompositeHandler</span> r <span class="kw">where</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="ot">    composite ::</span> r <span class="ot">-&gt;</span> r <span class="ot">-&gt;</span> r</span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="kw">instance</span> <span class="dt">CompositeHandler</span> <span class="dt">Area</span> <span class="kw">where</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    composite (<span class="dt">Area</span> x) (<span class="dt">Area</span> y) <span class="ot">=</span> <span class="dt">Area</span> (x <span class="op">+</span> y)</span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="op">&gt;</span> area (composite (rect <span class="dv">3</span> <span class="dv">5</span>) (circle <span class="dv">1</span>))</span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="fl">18.141592</span></span></code></pre></div>
<p>OO style:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">data</span> <span class="dt">Composite</span> a b <span class="ot">=</span> <span class="dt">Composite</span> {<span class="ot"> first ::</span> a,<span class="ot"> second ::</span> b }</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">instance</span> (<span class="dt">Area</span> a, <span class="dt">Area</span> b) <span class="ot">=&gt;</span> <span class="dt">Area</span> (<span class="dt">Composite</span> a b) <span class="kw">where</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>    area (<span class="dt">Composite</span> x y) <span class="ot">=</span> area x <span class="op">+</span> area y</span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="op">&gt;</span> area (<span class="dt">Composite</span> (<span class="dt">Rect</span> <span class="dv">3</span> <span class="dv">5</span>) (<span class="dt">Circle</span> <span class="dv">1</span>))</span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="fl">18.141592</span></span></code></pre></div>
<h3 id="collections">Collections</h3>
<p>If we wanted to encode a list of shapes:</p>
<ul>
<li>A final style list, <code>[(forall a. (ShapeHandlers a, CompositeHandler a) =&gt; a)]</code>, uses a universal quantifier and closes the list of supported variants</li>
<li>An OO style list will have to use an existensial quantifier and close the list of supported operations</li>
</ul>
<h3 id="operations-on-more-than-one-value">Operations on more than one value</h3>
<p>The <code>area</code> operation discussed earlier converts a given value to a result. But what if we wanted an operation that processes two shapes, like generating a diff of them?</p>
<p>This is where all styles discussed above fall short as far as I'm aware.</p>
<h2 id="the-fifth-approach-composition-of-atoms">The fifth approach: Composition of atoms</h2>
<p>All the approaches discussed above failed when put to the test. The following approach fares better -</p>
<p>We build upon the OO approach's basic shapes and combine them into a concrete <code>Shape</code> sum type:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="ot">{-# LANGUAGE DeriveGeneric, DeriveAnyClass #-}</span></span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw">data</span> <span class="dt">Shape</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="ot">=</span> <span class="dt">SRect</span> <span class="dt">Rect</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>    <span class="op">|</span> <span class="dt">SCircle</span> <span class="dt">Circle</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>    <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">Area</span>)</span></code></pre></div>
<p>We use <code>Generic</code> and <code>DefaultSignatures</code> based derivations to derive our class instances (the derivation of <code>Area</code> is left as an exercise for the reader).</p>
<p>This approach allows us to implement our basic types, operations, and instances in a modular way, while only closing the type at the top-level. It does allow us to implement operations on more than one value (such as diffs), and we can encode a list in either of the styles supported by Final or OO styles.</p>
<p>Discussion:</p>
<ul>
<li><img src="/images/reddit.svg" alt="reddit" style="width: 20px; display: inline;"/> <a href="https://www.reddit.com/r/haskell/comments/dsgr0r/the_four_simple_ways_to_encode_sumtypes/">r/haskell</a></li>
</ul>
<p>(image credit: <a href="https://commons.wikimedia.org/wiki/File:Loc_Bloc_example_1_of_Disney.JPG">MissMarvel50sWorld</a>)</p>

        <br>
        <br>

        <!--Share buttons-->
        <div class="social-buttons">
            <a href="https://twitter.com/share" class="twitter-share-button"
                                                data-url="https://yairchu.github.io/blog" data-text="Check out: The four simple ways to encode sum-types - " data-via="yairchu">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
            <a href="https://twitter.com/yairchu" class="twitter-follow-button" data-show-count="false" data-dnt="true">Follow @yairchu</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
            <div class="fb-like" data-href="" data-layout="button" data-action="like" data-show-faces="true" data-share="true"></div>
        </div>
</article>

</div>

<footer>
    Web site built with Haskell using <a href="https://github.com/ChrisPenner/slick">slick</a> ❤️
</footer>

<link href='https://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
<script src="/js/main.js"></script>
</body>
</html>
