<!DOCTYPE html>
<html lang="en" dir="ltr">
<head profile="http://www.w3.org/2005/10/profile">
  <meta name="description" content="Yair&#39;s website">
  <meta name="author" content="Yair Chuchem">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@yairchu">
<meta name="twitter:creator" content="@yairchu">
<meta name="twitter:title" content="Leet Haskell-style lazy evaluation in Python">
  <meta name="twitter:description" content="Haskell-style lazy evaluation in Python">
  <meta name="twitter:image" content="https://yairchu.github.io//images/transparent-snake.jpg">
  <title>Leet Haskell-style lazy evaluation in Python</title>
  <link rel="stylesheet" href="/css/syntax.css">
  <meta property="og:title" content="Leet Haskell-style lazy evaluation in Python" />
  <meta property="og:image" content="https://yairchu.github.io/images/transparent-snake.jpg" />
  <meta charset="UTF-8">
  <meta name=viewport content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/style.css">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3ZVL4J64MW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3ZVL4J64MW');
  </script>
</head>
<body>
  <header dir="ltr">
      <nav>
          <a id="beacon" href="/">
              <div id="home-text"> HOME </div>
          </a>
      </nav>
  
      <div class="right-sidebar">
          <a class="ext-link" href="https://github.com/yairchu">
            <img src="/images/github-logo.png" alt="Github Profile"/>
        </a>

          <a class="ext-link" href="https://twitter.com/yairchu">
            <img src="/images/twitter-logo.png" alt="Twitter Profile"/>
        </a>
    <div id="theme-button">DAY</div>
      </div>
  </header>

<div id="page">
  <div class="wrapper">
    <div class="masthead">
      <span class="title">
        Leet Haskell-style lazy evaluation in Python
      </span>

      <img class="post-image" src="/images/transparent-snake.jpg">
      <span class="byline">by Yair Chuchem</span>
      <span class="date">2022.09.15</span>
      <div class="metadata">
      </div>
      <div class="tags">
        <a href="/tag/code" class="tag">code</a>
        <a href="/tag/haskell" class="tag">haskell</a>
        <a href="/tag/python" class="tag">python</a>
        <a href="/tag/lazy-evaluation" class="tag">lazy-evaluation</a>
      </div>
    </div>
  </div>
  <article class="post">
    <p>Haskellers take pride in lazy evaluation, with perhaps its proudest
achievement being the world renowned <a
href="https://stackoverflow.com/q/1105765/40916">fibonacci
code-golf</a>:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>fibs <span class="ot">=</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">1</span> <span class="op">:</span> <span class="fu">zipWith</span> (<span class="op">+</span>) fibs (<span class="fu">tail</span> fibs)</span></code></pre></div>
<p>Should Pythoneers envy this majestic implementation? Not anymore!</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="at">@leet</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fibs():</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> <span class="dv">1</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> <span class="dv">1</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> <span class="cf">from</span> <span class="bu">map</span>(operator.add, fibs(), itertools.islice(fibs(), <span class="dv">1</span>, <span class="va">None</span>))</span></code></pre></div>
<p>Note that using the <code>leet</code> decorator is essential, without
it, it would have been terribly inefficient. Here it is:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> leet(gen):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Decorate a generator-producing function  </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">    to memoize its consumed values for all eternity.</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    original <span class="op">=</span> gen()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    as_list <span class="op">=</span> []</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> result():</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> itertools.count():</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> <span class="bu">len</span>(as_list):</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                as_list.append(<span class="bu">next</span>(original))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> as_list[i]</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code></pre></div>
<p>Note that the Python version has a significant advantage over the
Haskell one, being that the documentation of the <code>leet</code>
decorator describes an important facet of this algorithm: its memory
consumption is far from ideal.</p>
<p>Suppose that you want to iterate over the fibonacci sequence until
you find the first item to satisfy some condition. Let's suppose that
this value is the 100-billionth value.</p>
<p>Neither this function or the Haskell one it is based on would be
useful for this, and you should be advise to use the canonical,
constant-memory Python fibonacci implementation instead:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> boring_fibs():</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    cur <span class="op">=</span> <span class="bu">next</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> cur</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        cur, <span class="bu">next</span> <span class="op">=</span> <span class="bu">next</span>, cur <span class="op">+</span> <span class="bu">next</span></span></code></pre></div>
<p>Should you ever prefer to use the leet version? Not really.</p>
<p>Does the leet version have any advantage over the plain one? Possibly
that it's cool, depending on who you're asking.</p>
<h2 id="in-defence-of-lazyness">In defence of lazyness</h2>
<p>Devout Haskellers may suggest that the code-golf fibonacci is only a
basic demonstration of an idea. A more practical example would be
sorting an array.</p>
<p>When you use Haskell's <code>sort</code> function but only consume
the first two elements of the result, it doesn't need to sort everything
and you get an O(n) of work rather than O(n * log(n)).</p>
<p>However you could implement it in Python as well:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lazy_quick_sort(gen):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Haskell-style lazy quick-sort.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    It doesn&#39;t need to fully sort everything to find the N smallest elements.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">    The complexity would be O(N*log(K)) where K is the ammount iterated,</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">    in comparison to O(N*log(N)) for the full sorting algorithm.</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">    An example use case is iterating over potential dates</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ordered by their level of attractiveness,</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    until one of them agrees to date you.</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">    (but be warned that the odds for that may be lower</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">     if you tend to use functions like this one)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    gen <span class="op">=</span> <span class="bu">iter</span>(gen)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        pivot <span class="op">=</span> <span class="bu">next</span>(gen)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">StopIteration</span>:</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    less <span class="op">=</span> []</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    more <span class="op">=</span> []</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> gen:</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        (less <span class="cf">if</span> x <span class="op">&lt;</span> pivot <span class="cf">else</span> more).append(x)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> <span class="cf">from</span> quick_sort(less)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> pivot</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> <span class="cf">from</span> quick_sort(more)</span></code></pre></div>
<h2 id="notes">Notes</h2>
<p>Header image was generated with DALL-E 2 and Photoshop combo.</p>
<ul>
<li>I first asked DALL-E for "a cute friendly floating snake built of
caterpillar treads in a natural environment, 3d render"</li>
<li>Then I edited the first version to remove the snake, with the
prompot "natural environment, 3d render". Note that without removing the
snake's reflection in the water DALL-E would bring it back rather than
making a backround.</li>
<li>In Photo-shop I overlaid the image with the snake on the background
image adding a gradient mask to make its tail fade to transparency,
which is my artistic interpretation of lazy evaluation in Python</li>
</ul>

    <br>
    <br>

    <!--Share buttons-->
    <div class="social-buttons">
      <a href="https://twitter.com/share" class="twitter-share-button" data-text="Check out: Leet Haskell-style lazy evaluation in Python - " data-via="yairchu">Tweet</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      <a href="https://twitter.com/yairchu" class="twitter-follow-button" data-show-count="false" data-dnt="true">Follow @yairchu</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      <div class="fb-like" data-href="" data-layout="button" data-action="like" data-show-faces="true" data-share="true"></div>
    </div>
</article>

</div>

<footer>
    Web site built with Haskell using <a href="https://github.com/ChrisPenner/slick">slick</a> ❤️
</footer>

<link href='https://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
<script src="/js/main.js"></script>
</body>
</html>
